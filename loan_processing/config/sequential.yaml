# Sequential Loan Processing Pattern
# Agents process loan applications in sequence, with each agent building on the previous results

name: "sequential_loan_processing"
description: "Standard sequential processing for comprehensive loan evaluation"
pattern_type: "sequential"
version: "1.0.0"

# Agent execution order and configuration
agents:
  - type: "intake"
    name: "Application Intake"
    required: true
    timeout_seconds: 180
    description: "Validates application data and checks for fraud indicators"
    success_conditions:
      - "validation_status in ['PASSED', 'REQUIRES_REVIEW']"
      - "confidence_score >= 0.7"
    
  - type: "credit" 
    name: "Credit Assessment"
    required: true
    timeout_seconds: 240
    depends_on: ["intake"]
    description: "Evaluates creditworthiness and calculates risk metrics"
    success_conditions:
      - "credit_score is not null"
      - "risk_category is not null"
      - "confidence_score >= 0.7"
    
  - type: "income"
    name: "Income Verification"
    required: true  
    timeout_seconds: 240
    depends_on: ["credit"]
    description: "Verifies employment and income stability"
    success_conditions:
      - "employment_verification_status != 'FAILED'"
      - "confidence_score >= 0.7"
    
  - type: "risk"
    name: "Risk Evaluation"
    required: true
    timeout_seconds: 300
    depends_on: ["income"]
    description: "Synthesizes all assessments and provides final recommendation"
    success_conditions:
      - "recommendation is not null"
      - "compliance_verified == true"
      - "confidence_score >= 0.8"

# Handoff rules between agents
handoff_rules:
  - from: "intake"
    to: "credit"
    conditions:
      - "validation_status == 'PASSED'"
      - "confidence_score >= 0.8"
    context_fields:
      - "validation_status"
      - "data_completeness_score"
      - "fraud_indicators" 
      - "verification_results"
      - "processing_path"
    failure_action: "manual_review"
    
  - from: "credit"
    to: "income"
    conditions:
      - "credit_tier in ['EXCELLENT', 'VERY_GOOD', 'GOOD', 'FAIR']"
      - "risk_category != 'VERY_HIGH'"
    context_fields:
      - "credit_score"
      - "credit_tier"
      - "debt_to_income_ratio"
      - "risk_category"
      - "red_flags"
    failure_action: "conditional_review"
    
  - from: "income" 
    to: "risk"
    conditions:
      - "employment_verification_status == 'VERIFIED'"
      - "confidence_score >= 0.7"
    context_fields:
      - "verified_monthly_income"
      - "employment_stability_score"
      - "income_trend"
      - "qualifying_income"
      - "concerns"
    failure_action: "income_verification_required"

# Final decision matrix
decision_matrix:
  auto_approve:
    description: "Automatic approval for low-risk applications"
    conditions:
      - "final_risk_category == 'LOW'"
      - "credit_score >= 750"
      - "debt_to_income_ratio <= 0.28"
      - "employment_verification_status == 'VERIFIED'"
      - "len(red_flags) == 0"
    max_amount: 500000
    rate_adjustment: 0.0
    
  conditional_approval:
    description: "Approval with conditions for moderate-risk applications"
    conditions:
      - "final_risk_category in ['LOW', 'MODERATE']"
      - "credit_score >= 650" 
      - "debt_to_income_ratio <= 0.43"
      - "employment_verification_status == 'VERIFIED'"
    max_amount: 400000
    rate_adjustment: 0.5
    required_conditions:
      - "Additional income documentation"
      - "Larger down payment if DTI > 0.36"
      
  manual_review:
    description: "Requires human review for high-risk or complex cases"
    conditions:
      - "final_risk_category in ['HIGH', 'VERY_HIGH']"
      - "credit_score < 650"
      - "debt_to_income_ratio > 0.43"
      - "len(red_flags) > 0"
      - "employment_verification_status != 'VERIFIED'"
    escalation_priority: "standard"
    
  auto_deny:
    description: "Automatic denial for applications that don't meet minimum standards"
    conditions:
      - "validation_status == 'FAILED'"
      - "credit_score < 580"
      - "debt_to_income_ratio > 0.50"
      - "len(fraud_indicators) > 0"
    denial_reason_required: true

# Error handling configuration  
error_handling:
  agent_timeout:
    action: "retry_once"
    max_retries: 1
    fallback: "manual_review"
    
  agent_failure:
    action: "escalate"
    fallback: "manual_review"
    
  invalid_output:
    action: "retry_with_clarification"
    max_retries: 2
    fallback: "manual_review"

# Monitoring and audit configuration
monitoring:
  track_metrics:
    - "processing_duration_by_agent"
    - "success_rate_by_agent"
    - "handoff_failure_rate"
    - "decision_distribution"
    
  audit_points:
    - "agent_handoffs"
    - "decision_factors"
    - "compliance_checks"
    - "error_occurrences"

# Compliance requirements
compliance:
  required_verifications:
    - "identity_verification"
    - "income_verification" 
    - "credit_verification"
    
  audit_trail_required: true
  decision_reasoning_required: true
  regulatory_flags:
    - "HMDA_reporting"
    - "fair_lending_compliance" 
    - "ATR_QM_compliance"